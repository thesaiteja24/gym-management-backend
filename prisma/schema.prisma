generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * ───────────────── ENUMS ─────────────────
 */

enum UserRole {
  systemAdmin
  gymAdmin
  trainer
  member
}

enum Gender {
  male
  female
  other
}

enum ExerciseType {
  repsOnly
  assisted
  weighted
  durationOnly
}

enum SetType {
  warmup
  working
  dropSet
  failureSet
}

enum ExerciseGroupType {
  superSet
  giantSet
}

enum WeightUnits {
  kg
  lbs
}

enum LengthUnits {
  cm
  inches
}

enum FitnessGoal {
  loseWeight
  gainMuscle
  improveEndurance
  improveFlexibility
  improveStrength
  improveOverallFitness
}

enum FitnessLevel {
  beginner
  intermediate
  advanced
}

enum EquipmentType {
  bodyweight
  dumbbells
  barbells
  kettlebells
  resistanceBands
  machines
  other
}

/**
 * ───────────────── USER ─────────────────
 */

model User {
  id                  String      @id @default(uuid(7))
  countryCode         String?
  phone               String      @unique
  phoneE164           String?     @unique
  firstName           String?
  lastName            String?
  dateOfBirth         DateTime?   @db.Date
  gender              Gender?
  preferredWeightUnit WeightUnits @default(kg)
  preferredLengthUnit LengthUnits @default(cm)
  height              Decimal?    @db.Decimal(6, 2)
  weight              Decimal?    @db.Decimal(6, 2)
  profilePicUrl       String?
  role                UserRole    @default(member)
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  gymsOwned        Gym[]               @relation("GymOwner")
  workoutLogs      WorkoutLog[]
  workoutTemplates WorkoutTemplate[]
  sessions         Session[]
  memberships      Membership[]
  fitnessProfile   UserFitnessProfile?

  @@index([countryCode])
  @@index([role])
}

model UserFitnessProfile {
  id                 String          @id @default(uuid(7))
  userId             String          @unique
  user               User            @relation(fields: [userId], references: [id])
  fitnessGoal        FitnessGoal?
  fitnessLevel       FitnessLevel?
  injuries           String?
  availableEquipment EquipmentType[]
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
}

/**
 * ───────────────── GYM ─────────────────
 */

model Gym {
  id          String   @id @default(uuid(7))
  name        String
  ownerId     String
  owner       User     @relation("GymOwner", fields: [ownerId], references: [id])
  description String?
  timings     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  memberships Membership[]

  @@index([ownerId])
  @@index([name])
}

/**
 * ───────────────── WORKOUT LOG ─────────────────
 */

model WorkoutLog {
  clientId  String?   @unique
  id        String    @id @default(uuid(7))
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  title     String?
  startTime DateTime?
  endTime   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  isEdited  Boolean   @default(false)
  editedAt  DateTime?
  deletedAt DateTime?

  exercises      WorkoutLogExercise[]
  exerciseGroups WorkoutLogExerciseGroup[]

  @@index([userId, createdAt])
}

/**
 * ───────────────── WORKOUT EXERCISE GROUP ─────────────────
 */
model WorkoutLogExerciseGroup {
  id                  String               @id @default(uuid(7))
  workoutId           String
  workout             WorkoutLog           @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  groupType           ExerciseGroupType
  groupIndex          Int
  restSeconds         Int?
  note                String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  workoutLogExercises WorkoutLogExercise[]

  @@index([workoutId, groupIndex])
}

/**
 * ───────────────── WORKOUT EXERCISE ─────────────────
 */

model WorkoutLogExercise {
  id              String                   @id @default(uuid(7))
  workoutId       String
  workout         WorkoutLog               @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exerciseId      String
  exercise        Exercise                 @relation(fields: [exerciseId], references: [id])
  exerciseGroupId String?
  exerciseGroup   WorkoutLogExerciseGroup? @relation(fields: [exerciseGroupId], references: [id], onDelete: SetNull)
  exerciseIndex   Int
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  sets WorkoutLogExerciseSet[]

  @@index([workoutId, exerciseIndex])
  @@index([exerciseId])
}

/**
 * ───────────────── WORKOUT SET ─────────────────
 */

model WorkoutLogExerciseSet {
  id                String             @id @default(uuid(7))
  workoutExerciseId String
  workoutExercise   WorkoutLogExercise @relation(fields: [workoutExerciseId], references: [id], onDelete: Cascade)
  setIndex          Int
  weight            Decimal?           @db.Decimal(8, 3)
  reps              Int?
  rpe               Int?
  durationSeconds   Int?
  note              String?
  restSeconds       Int?
  setType           SetType            @default(working)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  @@index([workoutExerciseId, setIndex])
}

/**
 * ───────────────── EXERCISE MASTER ─────────────────
 */

model Exercise {
  id                   String       @id @default(uuid(7))
  title                String
  instructions         String?
  thumbnailUrl         String?
  videoUrl             String?
  primaryMuscleGroupId String?
  primaryMuscleGroup   MuscleGroup? @relation("PrimaryMuscleGroup", fields: [primaryMuscleGroupId], references: [id])
  equipmentId          String?
  equipment            Equipment?   @relation(fields: [equipmentId], references: [id])
  exerciseType         ExerciseType @default(weighted)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  otherMuscleGroups   ExerciseMuscleGroup[]
  workoutLogExercises WorkoutLogExercise[]
  templateExercises   WorkoutTemplateExercise[]

  @@index([title])
  @@index([primaryMuscleGroupId])
  @@index([equipmentId])
}

/**
 * ───────────────── EQUIPMENT ─────────────────
 */

model Equipment {
  id           String         @id @default(uuid(7))
  title        String         @unique
  thumbnailUrl String?
  type         EquipmentType?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  exercises Exercise[]
}

/**
 * ───────────────── MUSCLE GROUP ─────────────────
 */

model MuscleGroup {
  id           String   @id @default(uuid(7))
  title        String   @unique
  thumbnailUrl String?
  tags         String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  primaryExercises Exercise[]            @relation("PrimaryMuscleGroup")
  exercises        ExerciseMuscleGroup[]
}

/**
 * ───────────────── EXERCISE ↔ MUSCLE GROUP ─────────────────
 */

model ExerciseMuscleGroup {
  id            String      @id @default(uuid(7))
  exerciseId    String
  exercise      Exercise    @relation(fields: [exerciseId], references: [id])
  muscleGroupId String
  muscleGroup   MuscleGroup @relation(fields: [muscleGroupId], references: [id])

  @@unique([exerciseId, muscleGroupId])
  @@index([muscleGroupId])
}

/**
 * ───────────────── MEMBERSHIP ─────────────────
 */

model Membership {
  id             String   @id @default(uuid(7))
  gymId          String
  gym            Gym      @relation(fields: [gymId], references: [id])
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  membershipType String?
  joinedAt       DateTime @default(now())
  status         String   @default("active")

  @@unique([gymId, userId])
  @@index([userId])
}

/**
 * ───────────────── SESSION ─────────────────
 */

model Session {
  id               String    @id @default(uuid(7))
  userId           String
  jwtId            String?
  refreshTokenHash String
  deviceId         String?
  ipAddress        String?
  userAgent        String?
  expiresAt        DateTime
  lastUsed         DateTime?
  createdAt        DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

/**
 * ───────────────── MEMBER'S WORKOUT TEMPLATES ─────────────────
 */

model WorkoutTemplate {
  id            String    @id @default(uuid(7))
  userId        String
  user          User      @relation(fields: [userId], references: [id])
  title         String
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?
  shareId       String?   @unique
  sourceShareId String?
  authorName    String?

  exercises      WorkoutTemplateExercise[]
  exerciseGroups WorkoutTemplateExerciseGroup[]

  @@index([userId])
}

model WorkoutTemplateExerciseGroup {
  id          String            @id @default(uuid(7))
  templateId  String
  template    WorkoutTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  groupType   ExerciseGroupType
  groupIndex  Int
  restSeconds Int?

  exercises WorkoutTemplateExercise[]

  @@index([templateId, groupIndex])
}

model WorkoutTemplateExercise {
  id            String          @id @default(uuid(7))
  templateId    String
  template      WorkoutTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  exerciseId    String
  exercise      Exercise        @relation(fields: [exerciseId], references: [id])
  exerciseIndex Int

  exerciseGroupId String?
  exerciseGroup   WorkoutTemplateExerciseGroup? @relation(fields: [exerciseGroupId], references: [id], onDelete: SetNull)

  sets WorkoutTemplateSet[]

  @@index([templateId, exerciseIndex])
}

model WorkoutTemplateSet {
  id                 String                  @id @default(uuid(7))
  templateExerciseId String
  templateExercise   WorkoutTemplateExercise @relation(fields: [templateExerciseId], references: [id], onDelete: Cascade)
  setIndex           Int
  setType            SetType                 @default(working)

  // Targets (Optional)
  weight          Decimal? @db.Decimal(8, 3)
  reps            Int?
  rpe             Int?
  durationSeconds Int?
  restSeconds     Int?
  note            String?

  @@index([templateExerciseId, setIndex])
}
